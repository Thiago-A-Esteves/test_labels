name: Label issues
on:
  issues:
    types:
      - reopened
      - opened
jobs:
  label_issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Define Labels
        run: |
          ISSUE_DATA=$(gh issue view "$NUMBER" --json body,title -q '.body + " " + .title' | tr '[:upper:]' '[:lower:]')
          LABELS="" # Start with empty labels
          MAPPING=(
            "bug:bug"
            "feature:feature"
            "documentation:documentation"
            "performance:performance"
            "security:security"
            "optimization:optimization"
            "interface|ui|ux:ui/ux"
            "test:testing"
            "refactor:refactor"
            "dependency:dependency"
            "api:api"
            "database|db:database"
            "configuration|config:configuration"
            "accessibility|a11y:accessibility"
            "regression:regression"
            "enhancement:enhancement"
            "breaking change:breaking-change"
            "support:support"
            "question:question"
            "help:help"
            "urgent:urgent"
            "blocked:blocked"
            "duplicate:duplicate"
            "wip:wip"
          )
          LABEL_FOUND=false # Flag to track if any label was found
          for MAP in "${MAPPING[@]}"; do
            KEYWORD=$(echo "$MAP" | cut -d':' -f1)
            LABEL=$(echo "$MAP" | cut -d':' -f2)
            if [[ "$ISSUE_DATA" =~ $KEYWORD ]]; then
              LABELS="$LABELS,$LABEL"
              LABEL_FOUND=true # Set flag to true if a label is added
            fi
          done

          # Remove leading comma if any
          LABELS=$(echo "$LABELS" | sed 's/^,//')

          # Add "triage" if no other labels were found
          if [[ "$LABEL_FOUND" == false ]]; then
            LABELS="triage"
          fi

          # Remove duplicates and trailing comma
          LABELS=$(echo "$LABELS" | tr ',' '\n' | sort -u | tr '\n' ',')
          LABELS=$(echo "$LABELS" | sed 's/,$//')

          echo "LABELS=$LABELS" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.issue.number }}

      - name: Add Labels to Issue
        run: gh issue edit "$NUMBER" --add-label "$LABELS"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.issue.number }}
